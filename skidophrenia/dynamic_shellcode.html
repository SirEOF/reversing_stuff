<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="Miasm: Python reverse engineering framework">
        <meta name="viewport" content="width=device-width">
        <title>Dynamic shellcode analysis &mdash; Miasm&#39;s blog</title>
            <link rel="stylesheet" href="../../../_static/normalize.css" type="text/css">
            <link rel="stylesheet" href="../../../_static/sphinx.css" type="text/css">
            <link rel="stylesheet" href="../../../_static/main.css" type="text/css">
            <link rel="stylesheet" href="../../../_static/flat.css" type="text/css">
            <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="../../../_static/font-awesome.min.css" type="text/css">
        <link rel="shortcut icon" href="../../../_static/tinkerer.ico" /><!-- Load modernizr and JQuery -->
        <script src="../../../_static/vendor/modernizr-2.6.2.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="../../../_static/vendor/jquery-1.8.2.min.js"><\/script>')</script>
        <script src="../../../_static/plugins.js"></script>
        <script src="../../../_static/main.js"></script>
        <link rel="search" title="Search" href="../../../search.html" /><link rel="next" title="GreHack 2015 Re150 challenge: as painless as possible" href="../../01/27/re150.html" /><link rel="prev" title="Rebuilding a cleaned &amp; working binary (Re150 part 2)" href="../../03/24/re150_rebuild.html" /><link rel="alternate" type="application/rss+xml" title="RSS" href="../../../rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="../../../_static/underscore.js"></script><script type="text/javascript" src="../../../_static/doctools.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            // Scroll to content if on small screen
            if (screen.width < 480)
            {
                $(document).scrollTop(document.getElementsByTagName("article")[0].offsetTop - 44);
            }
        });
    </script></head>
    <body role="document">
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container"><header role="banner">
            <hgroup>
              <h1><a href="../../../index.html">Miasm&#39;s blog</a></h1><h2>Reverse engineering framework</h2></hgroup>
          </header>
      <nav role="navigation">
            <ul><li class="main-nav">
                  <a href="../../../index.html">Home</a>
                </li>
              <li class="main-nav">
                  <a href="../../../pages/about.html">About</a>
                </li>
              </ul>
          </nav><div class="main-container" role="main"><div class="main wrapper body clearfix"><article><div class="timestamp postmeta">
            <span>February 12, 2016</span>
        </div>
    <div class="section" id="dynamic-shellcode-analysis">
<h1>Dynamic shellcode analysis</h1>
<p>In this article, we will study a shellcode using dynamic analysis. This analysis
includes a description of Miasm internals, which explains its length. The
shellcode is in the archive <a class="reference download internal" href="../../../_downloads/dyn_sc_shellcodes.zip" download=""><span class="xref download docutils literal"><span class="pre">dyn_sc_shellcodes.zip</span></span></a>, protected with
the password <span class="docutils literal"><span class="pre">infected</span></span>. The final script is here: <a class="reference download internal" href="../../../_downloads/dyn_sc_run.py" download=""><span class="xref download docutils literal"><span class="pre">dyn_sc_run.py</span></span></a></p>
<div class="contents local topic" id="overview">
<p class="topic-title first">Overview:</p>
<ul class="simple">
<li><a class="reference internal" href="#first-blood" id="id4">First blood</a></li>
<li><a class="reference internal" href="#symbolic-execution" id="id5">Symbolic Execution</a></li>
<li><a class="reference internal" href="#emulation" id="id6">Emulation</a></li>
<li><a class="reference internal" href="#deeper-in-the-shellcode" id="id7">Deeper in the Shellcode</a></li>
<li><a class="reference internal" href="#party-hard" id="id8">Party Hard</a></li>
<li><a class="reference internal" href="#final-words" id="id9">Final words</a></li>
</ul>
</div>
<p>This analysis is based on Miasm revision <a class="reference external" href="https://github.com/cea-sec/miasm/commit/2cf69707481ba4b0dd163b49d99bc9a021162944">2cf6970</a>.</p>
<div id="more"> </div><div class="section" id="first-blood">
<h2><a class="toc-backref" href="#id4">First blood</a></h2>
<p>Here is a raw dump of the shellcode:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="mi">00000000</span>  <span class="mi">50</span> <span class="mi">59</span> <span class="mi">49</span> <span class="mi">49</span> <span class="mi">49</span> <span class="mi">49</span> <span class="mi">49</span> <span class="mi">49</span>  <span class="mi">49</span> <span class="mi">49</span> <span class="mi">49</span> <span class="mi">49</span> <span class="mi">49</span> <span class="mi">49</span> <span class="mi">49</span> <span class="mi">49</span>  <span class="o">|</span><span class="n">PYIIIIIIIIIIIIII</span><span class="o">|</span>
<span class="mi">00000010</span>  <span class="mi">49</span> <span class="mi">49</span> <span class="mi">37</span> <span class="mi">51</span> <span class="mi">5</span><span class="n">a</span> <span class="mi">6</span><span class="n">a</span> <span class="mi">41</span> <span class="mi">58</span>  <span class="mi">50</span> <span class="mi">30</span> <span class="mi">41</span> <span class="mi">30</span> <span class="mi">41</span> <span class="mi">6</span><span class="n">b</span> <span class="mi">41</span> <span class="mi">41</span>  <span class="o">|</span><span class="n">II7QZjAXP0A0AkAA</span><span class="o">|</span>
<span class="mi">00000020</span>  <span class="mi">51</span> <span class="mi">32</span> <span class="mi">41</span> <span class="mi">42</span> <span class="mi">32</span> <span class="mi">42</span> <span class="mi">42</span> <span class="mi">30</span>  <span class="mi">42</span> <span class="mi">42</span> <span class="mi">41</span> <span class="mi">42</span> <span class="mi">58</span> <span class="mi">50</span> <span class="mi">38</span> <span class="mi">41</span>  <span class="o">|</span><span class="n">Q2AB2BB0BBABXP8A</span><span class="o">|</span>
<span class="mi">00000030</span>  <span class="mi">42</span> <span class="mi">75</span> <span class="mi">4</span><span class="n">a</span> <span class="mi">49</span> <span class="mi">62</span> <span class="mi">78</span> <span class="mi">6</span><span class="n">a</span> <span class="mi">4</span><span class="n">b</span>  <span class="mi">64</span> <span class="mi">58</span> <span class="mi">50</span> <span class="mi">5</span><span class="n">a</span> <span class="mi">6</span><span class="n">b</span> <span class="mi">39</span> <span class="mi">6</span><span class="n">e</span> <span class="mi">36</span>  <span class="o">|</span><span class="n">BuJIbxjKdXPZk9n6</span><span class="o">|</span>
<span class="mi">00000040</span>  <span class="mi">6</span><span class="n">c</span> <span class="mi">49</span> <span class="mi">4</span><span class="n">b</span> <span class="mi">67</span> <span class="mi">4</span><span class="n">b</span> <span class="mi">30</span> <span class="mi">65</span> <span class="mi">6</span><span class="n">e</span>  <span class="mi">7</span><span class="n">a</span> <span class="mi">49</span> <span class="mi">42</span> <span class="mi">54</span> <span class="mi">46</span> <span class="mi">6</span><span class="n">b</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">79</span>  <span class="o">|</span><span class="n">lIKgK0enzIBTFkly</span><span class="o">|</span>
<span class="mi">00000050</span>  <span class="mi">7</span><span class="n">a</span> <span class="mi">4</span><span class="n">b</span> <span class="mi">77</span> <span class="mi">73</span> <span class="mi">77</span> <span class="mi">70</span> <span class="mi">77</span> <span class="mi">70</span>  <span class="mi">4</span><span class="n">c</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">66</span> <span class="mi">54</span> <span class="mi">57</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">4</span><span class="n">f</span> <span class="mi">5</span><span class="n">a</span>  <span class="o">|</span><span class="n">zKwswpwpLlfTWlOZ</span><span class="o">|</span>
<span class="mi">00000060</span>  <span class="mi">39</span> <span class="mi">72</span> <span class="mi">6</span><span class="n">b</span> <span class="mi">4</span><span class="n">a</span> <span class="mi">6</span><span class="n">b</span> <span class="mi">4</span><span class="n">f</span> <span class="mi">59</span> <span class="mi">42</span>  <span class="mi">5</span><span class="n">a</span> <span class="mi">63</span> <span class="mi">48</span> <span class="mi">68</span> <span class="mi">58</span> <span class="mi">63</span> <span class="mi">59</span> <span class="mi">6</span><span class="n">f</span>  <span class="o">|</span><span class="mi">9</span><span class="n">rkJkOYBZcHhXcYo</span><span class="o">|</span>
<span class="mi">00000070</span>  <span class="mi">59</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">4</span><span class="n">b</span> <span class="mi">4</span><span class="n">f</span> <span class="mi">7</span><span class="n">a</span> <span class="mi">55</span> <span class="mi">76</span> <span class="mi">77</span>  <span class="mi">45</span> <span class="mi">4</span><span class="n">f</span> <span class="mi">67</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">77</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">43</span> <span class="mi">72</span>  <span class="o">|</span><span class="n">YoKOzUvwEOglwlCr</span><span class="o">|</span>
<span class="o">...</span>
</pre></div>
</div>
<p>We can note that this shellcode is in pure ascii. Let&#8217;s disassemble its first
basic block:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">miasm</span><span class="o">/</span><span class="n">example</span><span class="o">/</span><span class="n">disasm</span><span class="o">/</span><span class="n">full</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">m</span> <span class="n">x86_32</span> <span class="n">shellcode</span><span class="o">.</span><span class="n">bin</span> <span class="o">--</span><span class="n">blockwatchdog</span> <span class="mi">1</span>
</pre></div>
</div>
<p>This gives the following graph (file <span class="docutils literal"><span class="pre">graph_execflow.dot</span></span>):</p>
<div class="figure align-center" id="id1">
<a class="reference internal image-reference" href="../../../_images/sc01_bbl1.svg"><img alt="../../../_images/sc01_bbl1.svg" src="../../../_images/sc01_bbl1.svg" width="30%" /></a>
<p class="caption"><span class="caption-text">First basic block of the shellcode</span></p>
</div>
<p>Note the <span class="docutils literal"><span class="pre">PUSH</span> <span class="pre">EAX</span></span> <span class="docutils literal"><span class="pre">POP</span> <span class="pre">ECX</span></span> to mimic a <span class="docutils literal"><span class="pre">MOV</span> <span class="pre">ECX,</span> <span class="pre">EAX</span></span>, keeping a pure
<em>ascii</em> encoding. As we can see, the shellcode starts with some computations,
and will <em>xor</em> a memory cell:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="mi">00000019</span> <span class="n">XOR</span>        <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ECX</span><span class="o">+</span><span class="mh">0x30</span><span class="p">],</span> <span class="n">AL</span>
</pre></div>
</div>
<p>We could analyze it manually or dynamically. For the exercise, we will try to
determine which pointer is manipulated here. Now, the question is: where does
the value <span class="docutils literal"><span class="pre">ECX</span> <span class="pre">+</span> <span class="pre">0x30</span></span> point to? In Miasm, there are at least two ways to
answer this:</p>
<ul class="simple">
<li>using a symbolic execution from the beginning to retrieve the equation of
<span class="docutils literal"><span class="pre">ECX</span></span> at address <em>0x19</em></li>
<li>using the <span class="docutils literal"><span class="pre">DependencyGraph</span></span>, whose goal is to track all the lines which
participate to the value of a selected variable. We won&#8217;t introduce this
module here, because a future post will be dedicated to it.</li>
</ul>
</div>
<div class="section" id="symbolic-execution">
<h2><a class="toc-backref" href="#id5">Symbolic Execution</a></h2>
<p>Here are the steps to perform a symbolic execution of a basic block:</p>
<ol class="arabic simple">
<li>disassemble the block</li>
<li>translate it in the Miasm intermediate representation (IR)</li>
<li>create an initial state</li>
<li>launch the symbolic execution</li>
</ol>
<p>The following code disassembles the shellcode from address <em>0x0</em> to <em>0x1C</em>
(after the <span class="docutils literal"><span class="pre">XOR</span></span>). Then we will translate it in IR and finally run the
symbolic execution, stopping at address <em>0x1C</em>. Here is the script:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">miasm2.analysis.machine</span> <span class="k">import</span> <span class="n">Machine</span>
<span class="kn">from</span> <span class="nn">miasm2.core.bin_stream</span> <span class="k">import</span> <span class="n">bin_stream_str</span>
<span class="kn">from</span> <span class="nn">miasm2.ir.symbexec</span> <span class="k">import</span> <span class="n">symbexec</span>

<span class="c1"># Create a bin_stream from a Python string</span>
<span class="n">bs</span> <span class="o">=</span> <span class="n">bin_stream_str</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="c1"># Get a Miasm x86 32bit machine</span>
<span class="n">machine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="s2">&quot;x86_32&quot;</span><span class="p">)</span>
<span class="c1"># Retrieve the disassemble and IR analysis</span>
<span class="n">dis_engine</span><span class="p">,</span> <span class="n">ira</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">dis_engine</span><span class="p">,</span> <span class="n">machine</span><span class="o">.</span><span class="n">ira</span>

<span class="c1"># link the disasm engine to the bin_stream</span>
<span class="n">mdis</span> <span class="o">=</span> <span class="n">dis_engine</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span>

<span class="c1"># Stop disassembler after the XOR</span>
<span class="n">mdis</span><span class="o">.</span><span class="n">dont_dis</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x1C</span><span class="p">]</span>
<span class="c1"># Disassemble one basic block</span>
<span class="n">block</span> <span class="o">=</span> <span class="n">mdis</span><span class="o">.</span><span class="n">dis_bloc</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># instanciate an IR analysis</span>
<span class="n">ir_arch</span> <span class="o">=</span> <span class="n">ira</span><span class="p">(</span><span class="n">mdis</span><span class="o">.</span><span class="n">symbol_pool</span><span class="p">)</span>
<span class="c1"># Translate asm basic block to an IR basic block</span>
<span class="n">ir_arch</span><span class="o">.</span><span class="n">add_bloc</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

<span class="c1"># Store IR graph</span>
<span class="nb">open</span><span class="p">(</span><span class="s1">&#39;ir_graph.dot&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ir_arch</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">dot</span><span class="p">())</span>

<span class="c1"># Initiate the symbolic execution engine</span>
<span class="c1"># regs_init associates EAX to EAX_init and to on</span>
<span class="n">sb</span> <span class="o">=</span> <span class="n">symbexec</span><span class="p">(</span><span class="n">ir_arch</span><span class="p">,</span> <span class="n">machine</span><span class="o">.</span><span class="n">mn</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">regs_init</span><span class="p">)</span>
<span class="c1"># Start execution at address 0</span>
<span class="c1"># IRDst represents the label of the next IR basic block to execute</span>
<span class="n">irdst</span> <span class="o">=</span> <span class="n">sb</span><span class="o">.</span><span class="n">emul_ir_blocs</span><span class="p">(</span><span class="n">ir_arch</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span> <span class="s1">&#39;ECX =&#39;</span><span class="p">,</span> <span class="n">sb</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">machine</span><span class="o">.</span><span class="n">mn</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">ECX</span><span class="p">]</span>
</pre></div>
</div>
<p>The output is:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">ECX</span> <span class="o">=</span> <span class="p">(</span><span class="n">EAX_init</span><span class="o">+</span><span class="mh">0xFFFFFFF0</span><span class="p">)</span>
</pre></div>
</div>
<p>So at this point, as the <em>xored</em> memory is located at <span class="docutils literal"><span class="pre">[ECX</span> <span class="pre">+</span> <span class="pre">0x30]</span></span>, the
pointer is in fact <span class="docutils literal"><span class="pre">(EAX_init+0xFFFFFFF0)</span> <span class="pre">+</span> <span class="pre">0x30</span> <span class="pre">=</span> <span class="pre">EAX_init</span> <span class="pre">+</span> <span class="pre">0x20</span></span>. By
the way, <span class="docutils literal"><span class="pre">EAX_init</span></span> is the value of <span class="docutils literal"><span class="pre">EAX</span></span> in the initial symbolic execution
state.</p>
<p>Actually, the shellcode has information about the value of <span class="docutils literal"><span class="pre">EAX</span></span> when it&#8217;s run
by the application. What I didn&#8217;t say is that this shellcode was executed after
an exploit which leads to the corruption of a vtable leading to a <span class="docutils literal"><span class="pre">CALL</span>
<span class="pre">EAX</span></span>. Hence the shellcode knows that when its first instruction is executed,
<span class="docutils literal"><span class="pre">EAX</span></span> points to it.</p>
<p>If you don&#8217;t want to bother writing Python code only to run a symbolic
execution, the script <span class="docutils literal"><span class="pre">miasm/example/ida/symbol_exec.py</span></span> will do the
trick. Under <em>IDA</em>, hit <em>Alt-F7</em> and run the script. Now, select the code you
want to execute and hit <em>F3</em>.</p>
<div class="figure align-center" id="id2">
<a class="reference internal image-reference" href="../../../_images/sc01_select_code.png"><img alt="../../../_images/sc01_select_code.png" src="../../../_images/sc01_select_code.png" style="width: 30%;" /></a>
<p class="caption"><span class="caption-text">Select the code on <em>IDA</em></span></p>
</div>
<p>You should have the following result:</p>
<div class="figure align-center" id="id3">
<a class="reference internal image-reference" href="../../../_images/sc01_se_result.png"><img alt="../../../_images/sc01_se_result.png" src="../../../_images/sc01_se_result.png" style="width: 60%;" /></a>
<p class="caption"><span class="caption-text">Result of the symbolic execution in <em>IDA</em></span></p>
</div>
<p>Note: the script only displays modified registers and memory. Here again, the
value of <span class="docutils literal"><span class="pre">ECX</span></span> is <span class="docutils literal"><span class="pre">EAX_init+0xFFFFFFF0</span></span>. Please, note that Miasm2 must be in
IDA&#8217;s python path for the script to run properly.</p>
<p>So the shellcode will modify itself. Even if we could continue the analysis
manually, here we are going to use the Miasm sandbox to run a dynamic execution.</p>
</div>
<div class="section" id="emulation">
<h2><a class="toc-backref" href="#id6">Emulation</a></h2>
<p>To continue the analysis, we will emulate the shellcode in a sandbox. For this,
Miasm offers multiple solutions.</p>
<p>There is a simple sandbox demonstration in the example
<span class="docutils literal"><span class="pre">miasm/example/jitter/x86_32.py</span></span>. Here is the core of the script:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Create a x86 32bit sandbox</span>
<span class="n">myjit</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="s2">&quot;x86_32&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">jitter</span><span class="p">()</span>
<span class="c1"># Add memory for the stack, and point ESP to this area</span>
<span class="n">myjit</span><span class="o">.</span><span class="n">init_stack</span><span class="p">()</span>

<span class="c1"># Read the shellcode</span>
<span class="n">data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="c1"># Add memory for the shellcode</span>
<span class="n">run_addr</span> <span class="o">=</span> <span class="mh">0x40000000</span>
<span class="n">myjit</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">add_memory_page</span><span class="p">(</span><span class="n">run_addr</span><span class="p">,</span> <span class="n">PAGE_READ</span> <span class="o">|</span> <span class="n">PAGE_WRITE</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="c1"># Trace registers values and mnemonics</span>
<span class="n">myjit</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">log_regs</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">myjit</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">log_mn</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Push special address 0x1337BEEF on the stack</span>
<span class="n">myjit</span><span class="o">.</span><span class="n">push_uint32_t</span><span class="p">(</span><span class="mh">0x1337beef</span><span class="p">)</span>

<span class="c1"># Add a breakpoint to special address 0x1337BEEF to stop emulation</span>
<span class="n">myjit</span><span class="o">.</span><span class="n">add_breakpoint</span><span class="p">(</span><span class="mh">0x1337beef</span><span class="p">,</span> <span class="n">code_sentinelle</span><span class="p">)</span>

<span class="c1"># Initialize and starts the emulator</span>
<span class="n">myjit</span><span class="o">.</span><span class="n">init_run</span><span class="p">(</span><span class="n">run_addr</span><span class="p">)</span>
<span class="n">myjit</span><span class="o">.</span><span class="n">continue_run</span><span class="p">()</span>
</pre></div>
</div>
<p>In this script, we start with an empty sandbox. If you don&#8217;t create space for
the stack, the first <span class="docutils literal"><span class="pre">PUSH</span></span> will trigger an error saying that the code is
trying to access an unmapped page. This explains the
<span class="docutils literal"><span class="pre">myjit.init_stack()</span></span>. <em>0x1337BEEF</em> is pushed on the stack to force a potential
<span class="docutils literal"><span class="pre">RET</span></span> to jump to a special address. We then add a breakpoint at this address
in order to spot such a behavior. So here is trace:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">RAX</span> <span class="mi">0000000000000000</span> <span class="n">RBX</span> <span class="mi">0000000000000000</span> <span class="n">RCX</span> <span class="mi">0000000000000000</span> <span class="n">RDX</span> <span class="mi">0000000000000000</span>
<span class="n">RSI</span> <span class="mi">0000000000000000</span> <span class="n">RDI</span> <span class="mi">0000000000000000</span> <span class="n">RSP</span> <span class="mi">000000000123</span><span class="n">FFFC</span> <span class="n">RBP</span> <span class="mi">0000000000000000</span>
<span class="n">zf</span> <span class="mi">0000000000000000</span> <span class="n">nf</span> <span class="mi">0000000000000000</span> <span class="n">of</span> <span class="mi">0000000000000000</span> <span class="n">cf</span> <span class="mi">0000000000000000</span>
<span class="n">RIP</span> <span class="mi">0000000040000000</span>
<span class="mi">40000000</span> <span class="n">PUSH</span>       <span class="n">EAX</span>
<span class="o">...</span>
<span class="mi">40000017</span> <span class="n">POP</span>        <span class="n">EAX</span>
<span class="n">RAX</span> <span class="mi">0000000000000041</span> <span class="n">RBX</span> <span class="mi">0000000000000000</span> <span class="n">RCX</span> <span class="mi">00000000</span><span class="n">FFFFFFF0</span> <span class="n">RDX</span> <span class="mi">00000000</span><span class="n">FFFFFFF0</span>
<span class="n">RSI</span> <span class="mi">0000000000000000</span> <span class="n">RDI</span> <span class="mi">0000000000000000</span> <span class="n">RSP</span> <span class="mi">000000000123</span><span class="n">FFFC</span> <span class="n">RBP</span> <span class="mi">0000000000000000</span>
<span class="n">zf</span> <span class="mi">0000000000000000</span> <span class="n">nf</span> <span class="mi">0000000000000001</span> <span class="n">of</span> <span class="mi">0000000000000000</span> <span class="n">cf</span> <span class="mi">0000000000000000</span>
<span class="n">RIP</span> <span class="mi">0000000040000017</span>
<span class="mi">40000018</span> <span class="n">PUSH</span>       <span class="n">EAX</span>
<span class="n">RAX</span> <span class="mi">0000000000000041</span> <span class="n">RBX</span> <span class="mi">0000000000000000</span> <span class="n">RCX</span> <span class="mi">00000000</span><span class="n">FFFFFFF0</span> <span class="n">RDX</span> <span class="mi">00000000</span><span class="n">FFFFFFF0</span>
<span class="n">RSI</span> <span class="mi">0000000000000000</span> <span class="n">RDI</span> <span class="mi">0000000000000000</span> <span class="n">RSP</span> <span class="mi">000000000123</span><span class="n">FFF8</span> <span class="n">RBP</span> <span class="mi">0000000000000000</span>
<span class="n">zf</span> <span class="mi">0000000000000000</span> <span class="n">nf</span> <span class="mi">0000000000000001</span> <span class="n">of</span> <span class="mi">0000000000000000</span> <span class="n">cf</span> <span class="mi">0000000000000000</span>
<span class="n">RIP</span> <span class="mi">0000000040000018</span>
<span class="mi">40000019</span> <span class="n">XOR</span>        <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ECX</span><span class="o">+</span><span class="mh">0x30</span><span class="p">],</span> <span class="n">AL</span>
<span class="n">WARNING</span><span class="p">:</span> <span class="n">address</span> <span class="mh">0x20</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">mapped</span> <span class="ow">in</span> <span class="n">virtual</span> <span class="n">memory</span><span class="p">:</span>
<span class="n">WARNING</span><span class="p">:</span> <span class="n">address</span> <span class="mh">0x20</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">mapped</span> <span class="ow">in</span> <span class="n">virtual</span> <span class="n">memory</span><span class="p">:</span>
<span class="o">...</span>
<span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_exception</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="ne">AssertionError</span>
</pre></div>
</div>
<p>In this log, the script fails at address <em>0x40000019</em>: the <span class="docutils literal"><span class="pre">XOR</span></span> analyzed
previously. We can see the error is that the shellcode tries to access unmapped
memory area at address <em>0x20</em>. In fact the initial state of the sandbox set
<span class="docutils literal"><span class="pre">EAX</span></span> to <em>0x0</em>. As the shellcode has been mapped at address <em>0x40000000</em>, the
lookup fails. To fix it, we set <span class="docutils literal"><span class="pre">EAX</span></span> to <em>0x40000000</em>:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">myjit</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">EAX</span> <span class="o">=</span> <span class="mh">0x40000000</span>
</pre></div>
</div>
<p>Now, the execution is able to continue after the self modifying code. Note that
the logs are very verbose. From now on, we will only activate the <em>block trace</em>
(see previous article for more details).</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">myjit</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">log_regs</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">myjit</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">log_mn</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>is replaced by:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">myjit</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">log_newbloc</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>The first basic block displayed:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">loc_0000000040000000</span><span class="p">:</span><span class="mh">0x40000000</span>
<span class="n">PUSH</span>       <span class="n">EAX</span>
<span class="n">POP</span>        <span class="n">ECX</span>
<span class="n">DEC</span>        <span class="n">ECX</span>
<span class="n">DEC</span>        <span class="n">ECX</span>
<span class="n">DEC</span>        <span class="n">ECX</span>
<span class="n">DEC</span>        <span class="n">ECX</span>
<span class="n">DEC</span>        <span class="n">ECX</span>
<span class="n">DEC</span>        <span class="n">ECX</span>
<span class="n">DEC</span>        <span class="n">ECX</span>
<span class="n">DEC</span>        <span class="n">ECX</span>
<span class="n">DEC</span>        <span class="n">ECX</span>
<span class="n">DEC</span>        <span class="n">ECX</span>
<span class="n">DEC</span>        <span class="n">ECX</span>
<span class="n">DEC</span>        <span class="n">ECX</span>
<span class="n">DEC</span>        <span class="n">ECX</span>
<span class="n">DEC</span>        <span class="n">ECX</span>
<span class="n">DEC</span>        <span class="n">ECX</span>
<span class="n">DEC</span>        <span class="n">ECX</span>
<span class="n">AAA</span>
<span class="n">PUSH</span>       <span class="n">ECX</span>
<span class="n">POP</span>        <span class="n">EDX</span>
<span class="n">PUSH</span>       <span class="mh">0x41</span>
<span class="n">POP</span>        <span class="n">EAX</span>
<span class="n">PUSH</span>       <span class="n">EAX</span>
<span class="n">XOR</span>        <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ECX</span><span class="o">+</span><span class="mh">0x30</span><span class="p">],</span> <span class="n">AL</span>
<span class="n">INC</span>        <span class="n">ECX</span>
<span class="n">IMUL</span>       <span class="n">EAX</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ECX</span><span class="o">+</span><span class="mh">0x41</span><span class="p">],</span> <span class="mh">0x51</span>
<span class="n">XOR</span>        <span class="n">AL</span><span class="p">,</span> <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ECX</span><span class="o">+</span><span class="mh">0x42</span><span class="p">]</span>
<span class="n">XOR</span>        <span class="n">AL</span><span class="p">,</span> <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">EDX</span><span class="o">+</span><span class="mh">0x42</span><span class="p">]</span>
<span class="n">XOR</span>        <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">EDX</span><span class="o">+</span><span class="mh">0x42</span><span class="p">],</span> <span class="n">AL</span>
<span class="n">INC</span>        <span class="n">ECX</span>
<span class="n">INC</span>        <span class="n">EDX</span>
<span class="n">POP</span>        <span class="n">EAX</span>
<span class="n">PUSH</span>       <span class="n">EAX</span>
<span class="n">CMP</span>        <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ECX</span><span class="o">+</span><span class="mh">0x42</span><span class="p">],</span> <span class="n">AL</span>
<span class="n">JNZ</span>        <span class="n">loc_000000004000007D</span><span class="p">:</span><span class="mh">0x4000007d</span>
<span class="o">-&gt;</span>      <span class="n">c_next</span><span class="p">:</span><span class="n">loc_0000000040000033</span><span class="p">:</span><span class="mh">0x40000033</span>  <span class="n">c_to</span><span class="p">:</span><span class="n">loc_000000004000007D</span><span class="p">:</span><span class="mh">0x4000007d</span>
</pre></div>
</div>
<p>The interesting point is the next basic block displayed:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">loc_000000004000001C</span><span class="p">:</span><span class="mh">0x4000001c</span>
<span class="n">INC</span>        <span class="n">ECX</span>
<span class="n">IMUL</span>       <span class="n">EAX</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ECX</span><span class="o">+</span><span class="mh">0x41</span><span class="p">],</span> <span class="mh">0x10</span>
<span class="n">XOR</span>        <span class="n">AL</span><span class="p">,</span> <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ECX</span><span class="o">+</span><span class="mh">0x42</span><span class="p">]</span>
<span class="n">XOR</span>        <span class="n">AL</span><span class="p">,</span> <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">EDX</span><span class="o">+</span><span class="mh">0x42</span><span class="p">]</span>
<span class="n">XOR</span>        <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">EDX</span><span class="o">+</span><span class="mh">0x42</span><span class="p">],</span> <span class="n">AL</span>
<span class="n">INC</span>        <span class="n">ECX</span>
<span class="n">INC</span>        <span class="n">EDX</span>
<span class="n">POP</span>        <span class="n">EAX</span>
<span class="n">PUSH</span>       <span class="n">EAX</span>
<span class="n">CMP</span>        <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ECX</span><span class="o">+</span><span class="mh">0x42</span><span class="p">],</span> <span class="n">AL</span>
<span class="n">JNZ</span>        <span class="n">loc_000000004000007D</span><span class="p">:</span><span class="mh">0x4000007d</span>
<span class="o">-&gt;</span>      <span class="n">c_to</span><span class="p">:</span><span class="n">loc_000000004000007D</span><span class="p">:</span><span class="mh">0x4000007d</span>    <span class="n">c_next</span><span class="p">:</span><span class="n">loc_0000000040000033</span><span class="p">:</span><span class="mh">0x40000033</span>
</pre></div>
</div>
<p>Note that this new basic block is in fact a <em>slice</em> of the first basic
block. Here is what happened:</p>
<ol class="arabic simple">
<li>Miasm translates the first basic block and starts its execution.</li>
<li>The execution reaches the automodifying code, which messes up the current basic
block.</li>
<li>The execution stops and this block is removed from the cache.</li>
<li>The engine resumes the execution, so the new basic block is handled as a new
one, disassembled and displayed</li>
</ol>
<p>Note this new basic block is a bit different from the end of the first basic
block.</p>
<p>before:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">IMUL</span>       <span class="n">EAX</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ECX</span><span class="o">+</span><span class="mh">0x41</span><span class="p">],</span> <span class="mh">0x51</span>
</pre></div>
</div>
<p>after</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">IMUL</span>       <span class="n">EAX</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ECX</span><span class="o">+</span><span class="mh">0x41</span><span class="p">],</span> <span class="mh">0x10</span>
</pre></div>
</div>
</div>
<div class="section" id="deeper-in-the-shellcode">
<h2><a class="toc-backref" href="#id7">Deeper in the Shellcode</a></h2>
<p>This basic block (<span class="docutils literal"><span class="pre">loc_000000004000001C</span></span>) decrypts the next stage. We could
stop the execution at <em>0x40000033</em> and dump the memory to the disk to watch the
next stage for further analysis. But wait! There is more:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">loc_0000000040000040</span><span class="p">:</span><span class="mh">0x40000040</span>
<span class="n">MOV</span>        <span class="n">ECX</span><span class="p">,</span> <span class="mh">0x3EB</span>
<span class="n">LODSB</span>
<span class="n">XOR</span>        <span class="n">AL</span><span class="p">,</span> <span class="mh">0x1C</span>
<span class="n">STOSB</span>
<span class="n">LOOP</span>       <span class="n">loc_0000000040000045</span><span class="p">:</span><span class="mh">0x40000045</span>
<span class="o">-&gt;</span>      <span class="n">c_next</span><span class="p">:</span><span class="n">loc_000000004000004B</span><span class="p">:</span><span class="mh">0x4000004b</span>  <span class="n">c_to</span><span class="p">:</span><span class="n">loc_0000000040000045</span><span class="p">:</span><span class="mh">0x40000045</span>
</pre></div>
</div>
<p>The code above is another deciphering loop. At this point, we will add a
breakpoint at address <em>0x4000004b</em> to dump the shellcode. This breakpoint will
trigger a callback which dumps the deciphered code from memory to the disk.</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="c1"># A breakpoint callback takes the jitter as first parameter</span>
<span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="n">jitter</span><span class="p">):</span>
    <span class="c1"># Dump data ad address run_addr with a length of len(data)</span>
    <span class="n">new_data</span> <span class="o">=</span> <span class="n">jitter</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">get_mem</span><span class="p">(</span><span class="n">run_addr</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="c1"># Save to disk</span>
    <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/tmp/dump.bin&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
    <span class="c1"># Stop execution</span>
    <span class="k">return</span> <span class="kc">False</span>

<span class="c1"># Register a callback to the breakpoint</span>
<span class="n">myjit</span><span class="o">.</span><span class="n">add_breakpoint</span><span class="p">(</span><span class="mh">0x4000004b</span><span class="p">,</span> <span class="n">dump</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">myjit</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">EAX</span> <span class="o">=</span> <span class="mh">0x40000000</span>
<span class="n">myjit</span><span class="o">.</span><span class="n">init_run</span><span class="p">(</span><span class="n">run_addr</span><span class="p">)</span>
<span class="n">myjit</span><span class="o">.</span><span class="n">continue_run</span><span class="p">()</span>
</pre></div>
</div>
<p>At this stage, a static analysis of the decrypted code is possible. But we will
perform a dynamic analysis to use the Miasm sandbox. Here is the next basic
block:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">loc_0000000040000058</span><span class="p">:</span><span class="mh">0x40000058</span>
<span class="n">POP</span>        <span class="n">ESI</span>
<span class="n">PUSH</span>       <span class="n">EBP</span>
<span class="n">MOV</span>        <span class="n">EBP</span><span class="p">,</span> <span class="n">ESP</span>
<span class="n">PUSH</span>       <span class="mh">0x6E6F</span>
<span class="n">PUSH</span>       <span class="mh">0x6D6C7275</span>
<span class="n">PUSH</span>       <span class="n">ESP</span>
<span class="n">PUSH</span>       <span class="mh">0xEC0E4E8E</span>
<span class="n">PUSH</span>       <span class="mh">0x6E2BCA17</span>
<span class="n">CALL</span>       <span class="n">loc_00000000400002CA</span><span class="p">:</span><span class="mh">0x400002ca</span>
<span class="o">-&gt;</span>      <span class="n">c_next</span><span class="p">:</span><span class="n">loc_0000000040000076</span><span class="p">:</span><span class="mh">0x40000076</span>
</pre></div>
</div>
<p><em>Spoiler</em>: for the trained eyes, we have a code pattern which stacks a special
string in memory:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;6D6C7275&quot;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;6E6F&quot;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="go">&#39;urlmon&#39;</span>
</pre></div>
</div>
<p>The logs raise another Miasm error (again) during the execution:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">loc_00000000400002D9</span><span class="p">:</span><span class="mh">0x400002d9</span>
<span class="n">PUSHAD</span>
<span class="n">XOR</span>        <span class="n">EAX</span><span class="p">,</span> <span class="n">EAX</span>
<span class="n">MOV</span>        <span class="n">EDX</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">FS</span><span class="p">:[</span><span class="n">EAX</span><span class="o">+</span><span class="mh">0x30</span><span class="p">]</span>
<span class="n">MOV</span>        <span class="n">EDX</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">EDX</span><span class="o">+</span><span class="mh">0xC</span><span class="p">]</span>
<span class="n">MOV</span>        <span class="n">EDX</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">EDX</span><span class="o">+</span><span class="mh">0x14</span><span class="p">]</span>
<span class="n">MOV</span>        <span class="n">ESI</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">EDX</span><span class="o">+</span><span class="mh">0x28</span><span class="p">]</span>
<span class="n">XOR</span>        <span class="n">EDI</span><span class="p">,</span> <span class="n">EDI</span>
<span class="n">XOR</span>        <span class="n">EAX</span><span class="p">,</span> <span class="n">EAX</span>
<span class="n">LODSB</span>
<span class="n">INC</span>        <span class="n">ESI</span>
<span class="n">TEST</span>       <span class="n">EAX</span><span class="p">,</span> <span class="n">EAX</span>
<span class="n">JZ</span>         <span class="n">loc_0000000040000300</span><span class="p">:</span><span class="mh">0x40000300</span>
<span class="o">-&gt;</span>      <span class="n">c_to</span><span class="p">:</span><span class="n">loc_0000000040000300</span><span class="p">:</span><span class="mh">0x40000300</span>    <span class="n">c_next</span><span class="p">:</span><span class="n">loc_00000000400002F3</span><span class="p">:</span><span class="mh">0x400002f3</span>
<span class="n">WARNING</span><span class="p">:</span> <span class="n">address</span> <span class="mh">0x30</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">mapped</span> <span class="ow">in</span> <span class="n">virtual</span> <span class="n">memory</span><span class="p">:</span>
<span class="o">...</span>
<span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_exception</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="ne">AssertionError</span>
</pre></div>
</div>
<p>There is an other access outside of the sandbox virtual memory at address <em>0x30</em>
during the execution of this basic block. Note that we don&#8217;t known the exact
address of the faulty instruction in this case. We can retrieve it by launching
the script in interactive mode:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">i</span> <span class="n">run_sc</span><span class="o">.</span><span class="n">py</span> <span class="n">shellcode</span><span class="o">.</span><span class="n">bin</span>
<span class="o">...</span>
<span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_exception</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="ne">AssertionError</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">hex</span><span class="p">(</span><span class="n">myjit</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">EIP</span><span class="p">)</span>
<span class="s1">&#39;0x400002dcL&#39;</span>
</pre></div>
</div>
<p>The faulty instruction is:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">MOV</span>        <span class="n">EDX</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">FS</span><span class="p">:[</span><span class="n">EAX</span><span class="o">+</span><span class="mh">0x30</span><span class="p">]</span>
</pre></div>
</div>
<p>Here, <span class="docutils literal"><span class="pre">EAX</span></span> is <em>0x0</em>, so the memory lookup is at address <em>0x30</em> which is not
mapped in memory. But there is a trick: the <em>real</em> memory lookup uses the
segment selector <span class="docutils literal"><span class="pre">FS</span></span>. By default, Miasm doesn&#8217;t emulate segmentation, which
explains the previous outcome.</p>
<p>As we are on <em>Windows</em>, we know that this code is a lookup of the <span class="docutils literal"><span class="pre">PEB</span></span>
(<em>Process Environment Block</em>) so we have two choices:</p>
<ol class="arabic simple">
<li>We can map a memory page at address <em>0x30</em> in which we insert a fake <span class="docutils literal"><span class="pre">PEB</span></span>
data.</li>
<li>The other solution is to assign a value to the segment selector <span class="docutils literal"><span class="pre">FS</span></span> and a
corresponding segment descriptor with a custom base address. This base
address will be a fresh memory area filled with a fake <span class="docutils literal"><span class="pre">PEB</span></span> structure. You
also have to activate the segmentation support in Miasm.</li>
</ol>
<p>Painful isn&#8217;t it? Fortunately, Miasm implements a minimal <em>Windows</em> structures
emulation (<span class="docutils literal"><span class="pre">miasm2.os_dep.win_api_x86_32_seh.py</span></span>).</p>
<p>The <span class="docutils literal"><span class="pre">PEB</span></span> contains interesting information like the linked list of the modules
mapped in memory by the loader. By default, if you activate the <em>Windows</em>
structures emulation, Miasm will create a <span class="docutils literal"><span class="pre">PEB</span></span> with dummy information related
to it&#8217;s loader. However, you can force Miasm to load specific modules and use
them to create a consistent loaded modules linked list (see below).</p>
<p>To load all this information automatically, you can use the class
<span class="docutils literal"><span class="pre">miasm2.analysis.sandbox::Sandbox_Win_x86_32</span></span> which takes a binary&#8217;s path as
input, and sets up a minimal environment like the one previously described. An
example is in <span class="docutils literal"><span class="pre">miasm/example/jitter/sandbox_pe_x86_32.py</span></span>.</p>
<p>The <em>PE</em> binary given to the sandbox is <span class="docutils literal"><span class="pre">iexplorer.exe</span></span> (the exploit
target). This binary will serve as a <em>host</em> and will be used by Miasm to build
the loader structure. Module dependencies will be loaded as well (they have to
be present in the <span class="docutils literal"><span class="pre">./win_dll</span></span> directory).</p>
<p>As the shellcode doesn&#8217;t interact with this binary, we can also load a dummy
binary (like <span class="docutils literal"><span class="pre">calc.exe</span></span>). Last but not least, if you don&#8217;t have <span class="docutils literal"><span class="pre">calc.exe</span></span>,
you can build a valid executable from the shellcode using <span class="docutils literal"><span class="pre">elfesteem</span></span>:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">elfesteem</span> <span class="k">import</span> <span class="n">pe_init</span>

<span class="c1"># Get the shellcode</span>
<span class="n">data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="c1"># Generate a PE</span>
<span class="n">pe</span> <span class="o">=</span> <span class="n">pe_init</span><span class="o">.</span><span class="n">PE</span><span class="p">(</span><span class="n">wsize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="c1"># Add a &quot;.text&quot; section containing the shellcode to the PE</span>
<span class="n">s_text</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">SHList</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;.text&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="mh">0x1000</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="c1"># Set the entrypoint to the shellcode&#39;s address</span>
<span class="n">pe</span><span class="o">.</span><span class="n">Opthdr</span><span class="o">.</span><span class="n">AddressOfEntryPoint</span> <span class="o">=</span> <span class="n">s_text</span><span class="o">.</span><span class="n">addr</span>
<span class="c1"># Write the PE to &quot;sc_pe.py&quot;</span>
<span class="nb">open</span><span class="p">(</span><span class="s1">&#39;sc_pe.exe&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pe</span><span class="p">))</span>
</pre></div>
</div>
<p>In the next part, we will base our script on
<span class="docutils literal"><span class="pre">miasm/example/jitter/sandbox_pe_x86_32.py</span></span>. This script is used to load a
binary and create a working environment. Here are the default options:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span>$ python run_sc.py  -h
usage: run_sc.py [-h] [-a ADDRESS] [-x] [-b] [-z] [-d] [-g GDBSERVER] [-j JITTER]
              [-q] [-i] [-s] [-o] [-y] [-l] [-r]
              filename

PE sandboxer

positional arguments:
  filename              PE Filename

optional arguments:
  -h, --help            show this help message and exit
  -a ADDRESS, --address ADDRESS
                        Force entry point address
  -x, --dumpall         Load base dll
  -b, --dumpblocs       Log disasm blocks
  -z, --singlestep      Log single step
  -d, --debugging       Debug shell
  -g GDBSERVER, --gdbserver GDBSERVER
                        Listen on port @port
  -j JITTER, --jitter JITTER
                        Jitter engine. Possible values are: tcc (default),
                        llvm, python
  -q, --quiet-function-calls
                        Don&#39;t log function calls
  -i, --dependencies    Load PE and its dependencies
  -s, --usesegm         Use segments
  -o, --load-hdr        Load pe hdr
  -y, --use-seh         Use windows SEH
  -l, --loadbasedll     Load base dll (path &#39;./win_dll&#39;)
  -r, --parse-resources
                        Load resources
</pre></div>
</div>
<p>Here, the interesting options are:</p>
<ul class="simple">
<li><span class="docutils literal"><span class="pre">-s</span></span> (<span class="docutils literal"><span class="pre">--usesegm</span></span>) to use segmentation</li>
<li><span class="docutils literal"><span class="pre">-y</span></span> (<span class="docutils literal"><span class="pre">--use-seh</span></span>) to generate minimalistic windows structures (yes, the
name is sadly chosen)</li>
<li><span class="docutils literal"><span class="pre">-l</span></span> (<span class="docutils literal"><span class="pre">--loadbasedll</span></span>) to arbitrarily load a bunch of modules/dll (more on
this later)</li>
<li><span class="docutils literal"><span class="pre">-b</span></span> (<span class="docutils literal"><span class="pre">--dumpblocs</span></span>) to display a block trace.</li>
</ul>
<p>As mentioned before, we can force the libraries to be loaded from a default list:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Sanbox.ALL_IMP_DLL</span>
<span class="n">ALL_IMP_DLL</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ntdll.dll&quot;</span><span class="p">,</span> <span class="s2">&quot;kernel32.dll&quot;</span><span class="p">,</span> <span class="s2">&quot;user32.dll&quot;</span><span class="p">,</span>
               <span class="s2">&quot;ole32.dll&quot;</span><span class="p">,</span> <span class="s2">&quot;urlmon.dll&quot;</span><span class="p">,</span>
               <span class="s2">&quot;ws2_32.dll&quot;</span><span class="p">,</span> <span class="s1">&#39;advapi32.dll&#39;</span><span class="p">,</span> <span class="s2">&quot;psapi.dll&quot;</span><span class="p">,</span>
               <span class="p">]</span>
</pre></div>
</div>
<p>We will modify the script to load and start the execution at the shellcode
address:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="c1"># Parse arguments</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">Sandbox_Win_x86_32</span><span class="o">.</span><span class="n">parser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;PE sandboxer&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;PE Filename&quot;</span><span class="p">)</span>

<span class="c1"># Get the shellcode from the second argument</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;shellcode&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;shellcode file&quot;</span><span class="p">)</span>

<span class="n">options</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<span class="c1"># Create sandbox</span>
<span class="n">sb</span> <span class="o">=</span> <span class="n">Sandbox_Win_x86_32</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>

<span class="c1"># Load the shellcode</span>
<span class="n">data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">shellcode</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">run_addr</span> <span class="o">=</span> <span class="mh">0x40000000</span>
<span class="n">sb</span><span class="o">.</span><span class="n">jitter</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">add_memory_page</span><span class="p">(</span><span class="n">run_addr</span><span class="p">,</span> <span class="n">PAGE_READ</span> <span class="o">|</span> <span class="n">PAGE_WRITE</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">sb</span><span class="o">.</span><span class="n">jitter</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">EAX</span> <span class="o">=</span> <span class="n">run_addr</span>

<span class="c1"># Run</span>
<span class="n">sb</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">run_addr</span><span class="p">)</span>
</pre></div>
</div>
<p>Here is the command line to run this script (here we use <span class="docutils literal"><span class="pre">box_upx.exe</span></span> as host executable):</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">i</span> <span class="n">run_sc</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">l</span> <span class="o">-</span><span class="n">y</span> <span class="n">miasm</span><span class="o">/</span><span class="n">example</span><span class="o">/</span><span class="n">samples</span><span class="o">/</span><span class="n">box_upx</span><span class="o">.</span><span class="n">exe</span> <span class="n">shellcode</span><span class="o">.</span><span class="n">bin</span>
</pre></div>
</div>
<p>Note that you will need a directory named <span class="docutils literal"><span class="pre">win_dll</span></span> containing <em>DLLs</em> (for
instance, the ones of windows XP). Here is the output:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">INFO</span><span class="p">]:</span> <span class="n">Loading</span> <span class="n">module</span> <span class="s1">&#39;ntdll.dll&#39;</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]:</span> <span class="n">Loading</span> <span class="n">module</span> <span class="s1">&#39;kernel32.dll&#39;</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]:</span> <span class="n">Loading</span> <span class="n">module</span> <span class="s1">&#39;user32.dll&#39;</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]:</span> <span class="n">Loading</span> <span class="n">module</span> <span class="s1">&#39;ole32.dll&#39;</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]:</span> <span class="n">Loading</span> <span class="n">module</span> <span class="s1">&#39;urlmon.dll&#39;</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]:</span> <span class="n">Loading</span> <span class="n">module</span> <span class="s1">&#39;ws2_32.dll&#39;</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]:</span> <span class="n">Loading</span> <span class="n">module</span> <span class="s1">&#39;advapi32.dll&#39;</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]:</span> <span class="n">Loading</span> <span class="n">module</span> <span class="s1">&#39;psapi.dll&#39;</span>
<span class="p">[</span><span class="n">WARNING</span><span class="p">]:</span> <span class="n">Create</span> <span class="n">dummy</span> <span class="n">entry</span> <span class="k">for</span> <span class="s1">&#39;msvcrt.dll&#39;</span>
<span class="p">[</span><span class="n">WARNING</span><span class="p">]:</span> <span class="n">Create</span> <span class="n">dummy</span> <span class="n">entry</span> <span class="k">for</span> <span class="s1">&#39;iertutil.dll&#39;</span>
<span class="p">[</span><span class="n">WARNING</span><span class="p">]:</span> <span class="n">Create</span> <span class="n">dummy</span> <span class="n">entry</span> <span class="k">for</span> <span class="s1">&#39;oleaut32.dll&#39;</span>
<span class="p">[</span><span class="n">WARNING</span><span class="p">]:</span> <span class="n">Create</span> <span class="n">dummy</span> <span class="n">entry</span> <span class="k">for</span> <span class="s1">&#39;rpcrt4.dll&#39;</span>
<span class="p">[</span><span class="n">WARNING</span><span class="p">]:</span> <span class="n">Create</span> <span class="n">dummy</span> <span class="n">entry</span> <span class="k">for</span> <span class="s1">&#39;shlwapi.dll&#39;</span>
<span class="p">[</span><span class="n">WARNING</span><span class="p">]:</span> <span class="n">Create</span> <span class="n">dummy</span> <span class="n">entry</span> <span class="k">for</span> <span class="s1">&#39;gdi32.dll&#39;</span>
<span class="p">[</span><span class="n">WARNING</span><span class="p">]:</span> <span class="n">Create</span> <span class="n">dummy</span> <span class="n">entry</span> <span class="k">for</span> <span class="s1">&#39;ws2help.dll&#39;</span>
<span class="n">INFO</span> <span class="p">:</span> <span class="n">Add</span> <span class="n">module</span> <span class="mi">0</span> <span class="s1">&#39;&#39;</span>
<span class="n">INFO</span> <span class="p">:</span> <span class="n">Add</span> <span class="n">module</span> <span class="mi">400000</span> <span class="s1">&#39;box_upx.exe&#39;</span>
<span class="n">INFO</span> <span class="p">:</span> <span class="n">Add</span> <span class="n">module</span> <span class="mi">45180000</span> <span class="s1">&#39;urlmon.dll&#39;</span>
<span class="n">INFO</span> <span class="p">:</span> <span class="n">Add</span> <span class="n">module</span> <span class="mi">7</span><span class="n">c800000</span> <span class="s1">&#39;kernel32.dll&#39;</span>
<span class="n">INFO</span> <span class="p">:</span> <span class="n">Add</span> <span class="n">module</span> <span class="mi">77</span><span class="n">da0000</span> <span class="s1">&#39;advapi32.dll&#39;</span>
<span class="n">INFO</span> <span class="p">:</span> <span class="n">Add</span> <span class="n">module</span> <span class="mi">7</span><span class="n">c910000</span> <span class="s1">&#39;ntdll.dll&#39;</span>
<span class="n">INFO</span> <span class="p">:</span> <span class="n">Add</span> <span class="n">module</span> <span class="mi">774</span><span class="n">a0000</span> <span class="s1">&#39;ole32.dll&#39;</span>
<span class="n">INFO</span> <span class="p">:</span> <span class="n">Add</span> <span class="n">module</span> <span class="mi">719</span><span class="n">f0000</span> <span class="s1">&#39;ws2_32.dll&#39;</span>
<span class="n">INFO</span> <span class="p">:</span> <span class="n">Add</span> <span class="n">module</span> <span class="mi">76</span><span class="n">ba0000</span> <span class="s1">&#39;psapi.dll&#39;</span>
<span class="n">INFO</span> <span class="p">:</span> <span class="n">Add</span> <span class="n">module</span> <span class="mf">7e390000</span> <span class="s1">&#39;user32.dll&#39;</span>
<span class="n">INFO</span> <span class="p">:</span> <span class="n">Ldr</span> <span class="mi">342</span><span class="n">f00</span>
</pre></div>
</div>
<p>Here, Miasm tries to load the required modules (<span class="docutils literal"><span class="pre">ntdll.dll</span></span>, ...). Some of
them are present in <span class="docutils literal"><span class="pre">win_dll/</span></span> and are loaded, some are not. For those
which are not present, Miasm will create a dummy base address and dummy exported
addresses (near <em>0x7111XXXX</em>). Next, Miasm loads the host binary
(<span class="docutils literal"><span class="pre">box_upx.exe</span></span>). Here is an extract of the block trace:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">PUSH</span>       <span class="mh">0xEC0E4E8E</span>
<span class="n">PUSH</span>       <span class="mh">0x6E2BCA17</span>
<span class="n">CALL</span>       <span class="n">loc_00000000400002CA</span><span class="p">:</span><span class="mh">0x400002ca</span>
<span class="o">-&gt;</span>      <span class="n">c_next</span><span class="p">:</span><span class="n">loc_0000000040000076</span><span class="p">:</span><span class="mh">0x40000076</span>
<span class="n">loc_00000000400002CA</span><span class="p">:</span><span class="mh">0x400002ca</span>
<span class="n">POP</span>        <span class="n">ECX</span>
<span class="n">CALL</span>       <span class="n">loc_00000000400002D9</span><span class="p">:</span><span class="mh">0x400002d9</span>
<span class="o">-&gt;</span>      <span class="n">c_next</span><span class="p">:</span><span class="n">loc_00000000400002D0</span><span class="p">:</span><span class="mh">0x400002d0</span>
<span class="n">loc_00000000400002D9</span><span class="p">:</span><span class="mh">0x400002d9</span>
<span class="n">PUSHAD</span>
<span class="n">XOR</span>        <span class="n">EAX</span><span class="p">,</span> <span class="n">EAX</span>
<span class="n">MOV</span>        <span class="n">EDX</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">FS</span><span class="p">:[</span><span class="n">EAX</span><span class="o">+</span><span class="mh">0x30</span><span class="p">]</span>
<span class="n">MOV</span>        <span class="n">EDX</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">EDX</span><span class="o">+</span><span class="mh">0xC</span><span class="p">]</span>
<span class="n">MOV</span>        <span class="n">EDX</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">EDX</span><span class="o">+</span><span class="mh">0x14</span><span class="p">]</span>
<span class="n">MOV</span>        <span class="n">ESI</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">EDX</span><span class="o">+</span><span class="mh">0x28</span><span class="p">]</span>
</pre></div>
</div>
<p>This is the part which extracts imports from the <span class="docutils literal"><span class="pre">PEB</span></span> structure. The
shellcode finds its dependencies using function and <em>DLL</em> hashes (<em>0xEC0E4E8E</em>
and <em>0x6E2BCA17</em>). This code is typical for a trained eye:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">LODSB</span>
<span class="n">TEST</span>       <span class="n">AL</span><span class="p">,</span> <span class="n">AL</span>
<span class="n">JZ</span>         <span class="n">loc_0000000040000342</span><span class="p">:</span><span class="mh">0x40000342</span>
<span class="o">-&gt;</span>      <span class="n">c_to</span><span class="p">:</span><span class="n">loc_0000000040000342</span><span class="p">:</span><span class="mh">0x40000342</span>    <span class="n">c_next</span><span class="p">:</span><span class="n">loc_000000004000033B</span><span class="p">:</span><span class="mh">0x4000033b</span>
<span class="n">loc_0000000040000337</span><span class="p">:</span><span class="mh">0x40000337</span>
<span class="n">TEST</span>       <span class="n">AL</span><span class="p">,</span> <span class="n">AL</span>
<span class="n">JZ</span>         <span class="n">loc_0000000040000342</span><span class="p">:</span><span class="mh">0x40000342</span>
<span class="o">-&gt;</span>      <span class="n">c_to</span><span class="p">:</span><span class="n">loc_0000000040000342</span><span class="p">:</span><span class="mh">0x40000342</span>    <span class="n">c_next</span><span class="p">:</span><span class="n">loc_000000004000033B</span><span class="p">:</span><span class="mh">0x4000033b</span>
<span class="n">loc_000000004000033B</span><span class="p">:</span><span class="mh">0x4000033b</span>
<span class="n">ROR</span>        <span class="n">EDI</span><span class="p">,</span> <span class="mh">0xD</span>
<span class="n">ADD</span>        <span class="n">EDI</span><span class="p">,</span> <span class="n">EAX</span>
</pre></div>
</div>
<p>This code snippet walks the <em>InLoadOrderModuleList</em> linked list and finds a
module whose name&#8217;s hash matches the provided one. In this case, it will be
<span class="docutils literal"><span class="pre">kernel32.dll</span></span>. Then it walks the export directory of this module the same way
to find an expected export. For the moment, we don&#8217;t know the searched function
but if we look at the next logs:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">ADD</span>        <span class="n">EAX</span><span class="p">,</span> <span class="n">EBP</span>
<span class="n">MOV</span>        <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ESP</span><span class="o">+</span><span class="mh">0x1C</span><span class="p">],</span> <span class="n">EAX</span>
<span class="n">POPAD</span>
<span class="n">RET</span>        <span class="mh">0x8</span>
<span class="n">loc_00000000400002D6</span><span class="p">:</span><span class="mh">0x400002d6</span>
<span class="n">PUSH</span>       <span class="n">ECX</span>
<span class="n">JMP</span>        <span class="n">EAX</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]:</span> <span class="n">kernel32_LoadLibraryA</span><span class="p">(</span><span class="n">dllname</span><span class="o">=</span><span class="mh">0x13ffe0</span><span class="p">)</span> <span class="n">ret</span> <span class="n">addr</span><span class="p">:</span> <span class="mh">0x40000076</span>
<span class="n">loc_0000000040000076</span><span class="p">:</span><span class="mh">0x40000076</span>
</pre></div>
</div>
<p>We have an information from the jitter that the code called the function
<span class="docutils literal"><span class="pre">LoadLibraryA</span></span> from the module <span class="docutils literal"><span class="pre">kernel32</span></span>. This is the resolved
function. But how does Miasm know this?</p>
<p>In fact each time you load a library in memory, Miasm adds a breakpoint on each
of its exported addresses, and remembers the relation between the address and
the exported name. When the emulated program counter reaches one of these
breakpoints, the emulation is paused. Miasm then tries to find a Python function
whose name has the form <span class="docutils literal"><span class="pre">ModuleName_ModuleFunction</span></span> and calls it.</p>
<p>In this case, we implement a minimalistic set of <em>Windows</em> functions which, once
called, will have the same side effects on the sandbox as the real function on
the registers/memory. For example, if a binary calls <span class="docutils literal"><span class="pre">rand</span></span>, we can force its
return value to make it less random:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">msvcrt_rand</span><span class="p">(</span><span class="n">jitter</span><span class="p">):</span>
    <span class="n">ret_ad</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jitter</span><span class="o">.</span><span class="n">func_args_cdecl</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">jitter</span><span class="o">.</span><span class="n">func_ret_stdcall</span><span class="p">(</span><span class="n">ret_ad</span><span class="p">,</span> <span class="mh">0x666</span><span class="p">)</span>
</pre></div>
</div>
<p>Those default functions are defined in the module
<span class="docutils literal"><span class="pre">miasm2.os_dep.win_api_x86_32</span></span>. Here is the code of <span class="docutils literal"><span class="pre">LoadLibraryA</span></span>:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">kernel32_LoadLibraryA</span><span class="p">(</span><span class="n">jitter</span><span class="p">):</span>

    <span class="c1"># jitter.func_args_stdcall is a helper which knows the current calling</span>
    <span class="c1"># convention (stack based here), and will unstack the return address</span>
    <span class="c1"># and one parameter (dllname). dllname is a pointer to the dll name</span>
    <span class="c1"># string in memory.</span>

    <span class="n">ret_ad</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">jitter</span><span class="o">.</span><span class="n">func_args_stdcall</span><span class="p">([</span><span class="s2">&quot;dllname&quot;</span><span class="p">])</span>

    <span class="n">libname</span> <span class="o">=</span> <span class="n">get_str_ansi</span><span class="p">(</span><span class="n">jitter</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">dllname</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">libname</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">winobjs</span><span class="o">.</span><span class="n">runtime_dll</span><span class="o">.</span><span class="n">lib_get_add_base</span><span class="p">(</span><span class="n">libname</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ret </span><span class="si">%x</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>

    <span class="c1"># jitter.func_ret_stdcall is another helper which will set the program</span>
    <span class="c1"># counter to the value ret_ad and the return value (EAX in this</span>
    <span class="c1"># convention) to ret.</span>

    <span class="n">jitter</span><span class="o">.</span><span class="n">func_ret_stdcall</span><span class="p">(</span><span class="n">ret_ad</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>
</pre></div>
</div>
<p>The jitter will then resume the execution to the fresh program counter, and the
execution resumes as if the <em>Windows</em> function had been called. This mechanism
allows us to script or simulate any function in Python!</p>
<p>By the way, if you implement the previous two helpers for <span class="docutils literal"><span class="pre">ARM</span></span>, you can use
the same Python code to simulate <span class="docutils literal"><span class="pre">LoadLibraryA</span></span> on <em>Windows</em> for this
architecture.</p>
<p>Note that if you want to get the module name, you can modify the script to log
it, or put a breakpoint at <em>0x40000076</em> to stop the execution and retrieve the
module name manually. Here is the modification:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">stop_exec</span><span class="p">(</span><span class="n">jitter</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">False</span>

<span class="n">sb</span><span class="o">.</span><span class="n">jitter</span><span class="o">.</span><span class="n">add_breakpoint</span><span class="p">(</span><span class="mh">0x40000076</span><span class="p">,</span> <span class="n">stop_exec</span><span class="p">)</span>

<span class="c1"># Run the shellcode</span>
<span class="n">sb</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">run_addr</span><span class="p">)</span>
</pre></div>
</div>
<p>And the live analysis:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">i</span> <span class="n">run_sc</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">l</span> <span class="o">-</span><span class="n">y</span> <span class="n">miasm</span><span class="o">/</span><span class="n">example</span><span class="o">/</span><span class="n">samples</span><span class="o">/</span><span class="n">box_upx</span><span class="o">.</span><span class="n">exe</span> <span class="n">shellcode</span><span class="o">.</span><span class="n">bin</span>
<span class="o">...</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">sb</span><span class="o">.</span><span class="n">jitter</span><span class="o">.</span><span class="n">get_str_ansi</span><span class="p">(</span><span class="mh">0x13ffe0</span><span class="p">)</span>
<span class="s1">&#39;urlmon&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="party-hard">
<h2><a class="toc-backref" href="#id8">Party Hard</a></h2>
<p>What&#8217;s next? Another crash, obviously!</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">loc_0000000040000083</span><span class="p">:</span><span class="mh">0x40000083</span>
<span class="n">PUSH</span>       <span class="n">EAX</span>
<span class="n">PUSH</span>       <span class="mh">0x6</span>
<span class="n">PUSH</span>       <span class="mh">0x0</span>
<span class="n">PUSH</span>       <span class="mh">0xDC8061B</span>
<span class="n">PUSH</span>       <span class="mh">0x2E773AE6</span>
<span class="n">CALL</span>       <span class="n">loc_00000000400002CA</span><span class="p">:</span><span class="mh">0x400002ca</span>
<span class="o">-&gt;</span>      <span class="n">c_next</span><span class="p">:</span><span class="n">loc_0000000040000097</span><span class="p">:</span><span class="mh">0x40000097</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
<span class="o">...</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknown api&#39;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">jitter</span><span class="o">.</span><span class="n">pc</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
<span class="ne">ValueError</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;unknown api&#39;</span><span class="p">,</span> <span class="s1">&#39;0x774c1473L&#39;</span><span class="p">,</span> <span class="s2">&quot;&#39;ole32_CoInitializeEx&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>What happened here? The function at address <em>0x400002ca</em> is the one which
resolves a function by hash. So the code resolved another function and tries to
call it. By the way, if you think that the log output is not really human
friendly, you can add some symbols to enhance it. For exemple:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="c1"># Links address 0x400002ca to the label name resolve_by_hash</span>
<span class="n">sb</span><span class="o">.</span><span class="n">jitter</span><span class="o">.</span><span class="n">ir_arch</span><span class="o">.</span><span class="n">symbol_pool</span><span class="o">.</span><span class="n">add_label</span><span class="p">(</span><span class="s1">&#39;resolve_by_hash&#39;</span><span class="p">,</span> <span class="mh">0x400002ca</span><span class="p">)</span>

<span class="c1"># Run the shellcode</span>
<span class="n">sb</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">run_addr</span><span class="p">)</span>
</pre></div>
</div>
<p>Result:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">loc_0000000040000083</span><span class="p">:</span><span class="mh">0x40000083</span>
<span class="n">PUSH</span>       <span class="n">EAX</span>
<span class="n">PUSH</span>       <span class="mh">0x6</span>
<span class="n">PUSH</span>       <span class="mh">0x0</span>
<span class="n">PUSH</span>       <span class="mh">0xDC8061B</span>
<span class="n">PUSH</span>       <span class="mh">0x2E773AE6</span>
<span class="n">CALL</span>       <span class="n">resolve_by_hash</span><span class="p">:</span><span class="mh">0x400002ca</span>
<span class="o">-&gt;</span>      <span class="n">c_next</span><span class="p">:</span><span class="n">loc_0000000040000097</span><span class="p">:</span><span class="mh">0x40000097</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
</pre></div>
</div>
<p>That&#8217;s a bit clearer. So what&#8217;s the problem now? Miasm reaches an internal
breakpoint on the function <span class="docutils literal"><span class="pre">ole32_CoInitializeEx</span></span>. Unluckily, this function is
not implemented in the default library. But are we really stuck here? Not
really. If you read the <a class="reference external" href="https://msdn.microsoft.com/library/windows/desktop/ms695279%28v=vs.85%29.aspx">Msdn</a> documentation, this function is used to initialize
a <em>COM</em> object and returns <em>0x1</em> if everything is ok. Fine, let&#8217;s implement a
minimalistic function in our script. Don&#8217;t you have the feeling of re
implementing the <em>Windows</em> API using architecture independent code here?</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ole32_CoInitializeEx</span><span class="p">(</span><span class="n">jitter</span><span class="p">):</span>
    <span class="n">ret_ad</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">jitter</span><span class="o">.</span><span class="n">func_args_stdcall</span><span class="p">([</span><span class="s2">&quot;pvReserved&quot;</span><span class="p">,</span> <span class="s2">&quot;dwCoInit&quot;</span><span class="p">])</span>
    <span class="n">jitter</span><span class="o">.</span><span class="n">func_ret_stdcall</span><span class="p">(</span><span class="n">ret_ad</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>WARNING: the function declaration position is important: it must be defined in
the script <em>before</em> the instanciation of the sanbox. This way, the declaration
belongs to the <span class="docutils literal"><span class="pre">globals()</span></span>. The logs are now:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">PUSH</span>       <span class="mh">0xDC8061B</span>
<span class="n">PUSH</span>       <span class="mh">0x2E773AE6</span>
<span class="n">CALL</span>       <span class="n">resolve_by_hash</span><span class="p">:</span><span class="mh">0x400002ca</span>
<span class="o">-&gt;</span>      <span class="n">c_next</span><span class="p">:</span><span class="n">loc_0000000040000097</span><span class="p">:</span><span class="mh">0x40000097</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]:</span> <span class="n">ole32_CoInitializeEx</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mh">0x6</span><span class="p">)</span> <span class="n">ret</span> <span class="n">addr</span><span class="p">:</span> <span class="mh">0x40000097</span>
</pre></div>
</div>
<p>Ok, now we have emulated the function. But there is more:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">PUSH</span>       <span class="mh">0x91AFCA54</span>
<span class="n">PUSH</span>       <span class="mh">0x6E2BCA17</span>
<span class="n">CALL</span>       <span class="n">resolve_by_hash</span><span class="p">:</span><span class="mh">0x400002ca</span>
<span class="o">-&gt;</span>      <span class="n">c_next</span><span class="p">:</span><span class="n">loc_00000000400000B0</span><span class="p">:</span><span class="mh">0x400000b0</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]:</span> <span class="n">kernel32_VirtualAlloc</span><span class="p">(</span><span class="n">lpvoid</span><span class="o">=</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">dwsize</span><span class="o">=</span><span class="mh">0x1000</span><span class="p">,</span> <span class="n">alloc_type</span><span class="o">=</span><span class="mh">0x1000</span><span class="p">,</span> <span class="n">flprotect</span><span class="o">=</span><span class="mh">0x40</span><span class="p">)</span> <span class="n">ret</span> <span class="n">addr</span><span class="p">:</span> <span class="mh">0x400000b0</span>
</pre></div>
</div>
<p>The shellcode resolved and called the function <span class="docutils literal"><span class="pre">kernel32_VirtualAlloc</span></span>, which
is already implemented in Miasm library. Then there is a call to another
function:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">PUSH</span>       <span class="mh">0xCFD98161</span>
<span class="n">PUSH</span>       <span class="mh">0x6E2BCA17</span>
<span class="n">CALL</span>       <span class="n">resolve_by_hash</span><span class="p">:</span><span class="mh">0x400002ca</span>
<span class="o">-&gt;</span>      <span class="n">c_next</span><span class="p">:</span><span class="n">loc_00000000400000C0</span><span class="p">:</span><span class="mh">0x400000c0</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]:</span> <span class="n">kernel32_GetVersion</span><span class="p">()</span> <span class="n">ret</span> <span class="n">addr</span><span class="p">:</span> <span class="mh">0x400000c0</span>
<span class="n">loc_00000000400000C0</span><span class="p">:</span><span class="mh">0x400000c0</span>
<span class="n">CMP</span>        <span class="n">AL</span><span class="p">,</span> <span class="mh">0x6</span>
<span class="n">JL</span>         <span class="n">loc_00000000400000D4</span><span class="p">:</span><span class="mh">0x400000d4</span>
</pre></div>
</div>
<p>Hey, it seems the shellcode has a different behavior depending on the <em>Windows</em>
version. Note that defining a custom <span class="docutils literal"><span class="pre">kernel32_GetVersion</span></span> will override the
one defined in Miasm library, and so you can play with its behavior to see the
impact on the shellcode. And now, another crash:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">PUSH</span>       <span class="mh">0xD7834A7E</span>
<span class="n">PUSH</span>       <span class="mh">0xAD74DBF2</span>
<span class="n">CALL</span>       <span class="n">resolve_by_hash</span><span class="p">:</span><span class="mh">0x400002ca</span>
<span class="o">-&gt;</span>      <span class="n">c_next</span><span class="p">:</span><span class="n">loc_0000000040000184</span><span class="p">:</span><span class="mh">0x40000184</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknown api&#39;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">jitter</span><span class="o">.</span><span class="n">pc</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
<span class="ne">ValueError</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;unknown api&#39;</span><span class="p">,</span> <span class="s1">&#39;0x7c936102L&#39;</span><span class="p">,</span> <span class="s2">&quot;&#39;ntdll_swprintf&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The script tries to resolve and execute <span class="docutils literal"><span class="pre">ntdll_swprintf</span></span>. This one will be a
bit harder. First step, let&#8217;s only dump the format string:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ntdll_swprintf</span><span class="p">(</span><span class="n">jitter</span><span class="p">):</span>
    <span class="n">ret_ad</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">jitter</span><span class="o">.</span><span class="n">func_args_stdcall</span><span class="p">([</span><span class="s2">&quot;dst&quot;</span><span class="p">,</span> <span class="s2">&quot;pfmt&quot;</span><span class="p">])</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="n">jitter</span><span class="o">.</span><span class="n">get_str_unic</span><span class="p">(</span><span class="n">jitter</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">pfmt</span><span class="p">)</span>
    <span class="nb">print</span> <span class="nb">repr</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">False</span>
</pre></div>
</div>
<p>Here is the output:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">PUSH</span>       <span class="mh">0xD7834A7E</span>
<span class="n">PUSH</span>       <span class="mh">0xAD74DBF2</span>
<span class="n">CALL</span>       <span class="n">resolve_by_hash</span><span class="p">:</span><span class="mh">0x400002ca</span>
<span class="o">-&gt;</span>      <span class="n">c_next</span><span class="p">:</span><span class="n">loc_0000000040000184</span><span class="p">:</span><span class="mh">0x40000184</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]:</span> <span class="n">ntdll_swprintf</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="mh">0x20000000</span><span class="p">,</span> <span class="n">pfmt</span><span class="o">=</span><span class="mh">0x13ffc8</span><span class="p">)</span> <span class="n">ret</span> <span class="n">addr</span><span class="p">:</span> <span class="mh">0x40000184</span>
<span class="s1">&#39;%S&#39;</span>
</pre></div>
</div>
<p>As the format string is really simple, let&#8217;s implement a minimalistic version
of <span class="docutils literal"><span class="pre">swprintf</span></span>:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ntdll_swprintf</span><span class="p">(</span><span class="n">jitter</span><span class="p">):</span>
    <span class="n">ret_ad</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">jitter</span><span class="o">.</span><span class="n">func_args_stdcall</span><span class="p">([</span><span class="s2">&quot;dst&quot;</span><span class="p">,</span> <span class="s2">&quot;pfmt&quot;</span><span class="p">])</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="n">jitter</span><span class="o">.</span><span class="n">get_str_unic</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pfmt</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;FMT:&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;%S&quot;</span><span class="p">:</span>
        <span class="n">psrc</span> <span class="o">=</span> <span class="n">jitter</span><span class="o">.</span><span class="n">pop_uint32_t</span><span class="p">()</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">jitter</span><span class="o">.</span><span class="n">get_str_ansi</span><span class="p">(</span><span class="n">psrc</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">src</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;unknown fmt </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fmt</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;OUT:&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">jitter</span><span class="o">.</span><span class="n">set_str_unic</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dst</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>

    <span class="c1"># Returns the string len in wchar unit</span>
    <span class="n">jitter</span><span class="o">.</span><span class="n">func_ret_stdcall</span><span class="p">(</span><span class="n">ret_ad</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Let&#8217;s have a look at the new output:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">PUSH</span>       <span class="mh">0xD7834A7E</span>
<span class="n">PUSH</span>       <span class="mh">0xAD74DBF2</span>
<span class="n">CALL</span>       <span class="n">resolve_by_hash</span><span class="p">:</span><span class="mh">0x400002ca</span>
<span class="o">-&gt;</span>      <span class="n">c_next</span><span class="p">:</span><span class="n">loc_0000000040000184</span><span class="p">:</span><span class="mh">0x40000184</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]:</span> <span class="n">ntdll_swprintf</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="mh">0x20000000</span><span class="p">,</span> <span class="n">pfmt</span><span class="o">=</span><span class="mh">0x13ffc8</span><span class="p">)</span> <span class="n">ret</span> <span class="n">addr</span><span class="p">:</span> <span class="mh">0x40000184</span>
<span class="n">FMT</span><span class="p">:</span> <span class="s1">&#39;%S&#39;</span>
<span class="n">OUT</span><span class="p">:</span> <span class="s1">&#39;hXXp://efyjlXXXXXXXXXXXXXXXXXXin.net/fXXXXXXXXXXXXXXX8867XXXX5&#39;</span>
<span class="n">loc_0000000040000184</span><span class="p">:</span><span class="mh">0x40000184</span>
<span class="o">...</span>
<span class="n">PUSH</span>       <span class="n">ESI</span>
<span class="n">PUSH</span>       <span class="n">EDI</span>
<span class="n">PUSH</span>       <span class="n">ECX</span>
<span class="n">CALL</span>       <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">EBP</span><span class="o">+</span><span class="mh">0xFFFFFFFC</span><span class="p">]</span>
<span class="o">-&gt;</span>      <span class="n">c_next</span><span class="p">:</span><span class="n">loc_0000000040000161</span><span class="p">:</span><span class="mh">0x40000161</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknown api&#39;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">jitter</span><span class="o">.</span><span class="n">pc</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
<span class="ne">ValueError</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;unknown api&#39;</span><span class="p">,</span> <span class="s1">&#39;0x451b65b3L&#39;</span><span class="p">,</span> <span class="s2">&quot;&#39;urlmon_URLDownloadToCacheFileW&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><em>Note: we deliberately changed the output of the script to avoid being flagged as a bad host.</em></p>
<p>Here is a minimalistic implementation of <span class="docutils literal"><span class="pre">URLDownloadToCacheFileW</span></span>:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="k">def</span> <span class="nf">urlmon_URLDownloadToCacheFileW</span><span class="p">(</span><span class="n">jitter</span><span class="p">):</span>
    <span class="n">ret_ad</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">jitter</span><span class="o">.</span><span class="n">func_args_stdcall</span><span class="p">([</span><span class="s2">&quot;lpunkcaller&quot;</span><span class="p">,</span>
                                             <span class="s2">&quot;szurl&quot;</span><span class="p">,</span>
                                             <span class="s2">&quot;szfilename&quot;</span><span class="p">,</span>
                                             <span class="s2">&quot;ccfilename&quot;</span><span class="p">,</span>
                                             <span class="s2">&quot;reserved&quot;</span><span class="p">,</span>
                                             <span class="s2">&quot;pbsc&quot;</span><span class="p">])</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">jitter</span><span class="o">.</span><span class="n">get_str_unic</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">szurl</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;URL:&quot;</span><span class="p">,</span> <span class="n">url</span>
    <span class="n">jitter</span><span class="o">.</span><span class="n">set_str_unic</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">szfilename</span><span class="p">,</span> <span class="s2">&quot;toto&quot;</span><span class="p">)</span>
    <span class="n">jitter</span><span class="o">.</span><span class="n">func_ret_stdcall</span><span class="p">(</span><span class="n">ret_ad</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>This will inform the shellcode we have correctly downloaded a binary and stored
it in a file named <span class="docutils literal"><span class="pre">toto</span></span>. And here is the final log:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">PUSH</span>       <span class="n">EDI</span>
<span class="n">PUSH</span>       <span class="n">ECX</span>
<span class="n">PUSH</span>       <span class="n">EAX</span>
<span class="n">PUSH</span>       <span class="n">EAX</span>
<span class="n">PUSH</span>       <span class="n">EAX</span>
<span class="n">PUSH</span>       <span class="n">EAX</span>
<span class="n">PUSH</span>       <span class="n">EAX</span>
<span class="n">PUSH</span>       <span class="n">EAX</span>
<span class="n">PUSH</span>       <span class="n">EAX</span>
<span class="n">PUSH</span>       <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">EBP</span><span class="o">+</span><span class="mh">0x8</span><span class="p">]</span>
<span class="n">PUSH</span>       <span class="mh">0x16B3FE88</span>
<span class="n">PUSH</span>       <span class="mh">0x6E2BCA17</span>
<span class="n">CALL</span>       <span class="n">resolve_by_hash</span><span class="p">:</span><span class="mh">0x400002ca</span>
<span class="o">-&gt;</span>      <span class="n">c_next</span><span class="p">:</span><span class="n">loc_00000000400002C5</span><span class="p">:</span><span class="mh">0x400002c5</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknown api&#39;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">jitter</span><span class="o">.</span><span class="n">pc</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
<span class="ne">ValueError</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;unknown api&#39;</span><span class="p">,</span> <span class="s1">&#39;0x7c802336L&#39;</span><span class="p">,</span> <span class="s2">&quot;&#39;kernel32_CreateProcessW&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Look at the first argument:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sb</span><span class="o">.</span><span class="n">jitter</span><span class="o">.</span><span class="n">get_str_unic</span><span class="p">(</span><span class="n">sb</span><span class="o">.</span><span class="n">jitter</span><span class="o">.</span><span class="n">get_stack_arg</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="go">&#39;toto&#39;</span>
</pre></div>
</div>
<p>The shellcode tries to execute the freshly downloaded binary.</p>
</div>
<div class="section" id="final-words">
<h2><a class="toc-backref" href="#id9">Final words</a></h2>
<p>First of all, congratulations to the readers who reached this point: that was a
big post. We have done a dynamic analysis of a shellcode <em>à la try&#8217;n die</em>
style. You have a good idea of Miasm&#8217;s internals as well. I admit the &#8216;cost&#8217; for
a Miasm&#8217;s newcomer is a bit expensive, and I realized it again while writing
those lines, but you may end up with a flexible tool to do such analysis. As a
remark, try to modify the <span class="docutils literal"><span class="pre">kernel32_myCreateProcess</span></span> to make it fail. The
shellcode behavior is modified. This type of approach is clearly not the
solution to all problems, but it can help on specific analysis. Note the script
can also be used on shellcodes belonging to the same campaign. As a bonus, you
have a second shellcode in the linked archive: Give it a try!</p>
</div>
</div>

    <div class="postmeta">
        <div class="author">
            <span>Posted by serpilliere</span>
        </div>
        
        <div class="tags">
            <span>
                Tags:
                <a href="../../../tags/disasm.html">disasm</a>, <a href="../../../tags/emulation.html">emulation</a>, <a href="../../../tags/ir.html">IR</a></span>
        </div>
        </div><ul class="related clearfix">
            <li class="left"> &laquo; <a href="../../03/24/re150_rebuild.html">Rebuilding a cleaned &amp; working binary (Re150 part 2)</a></li>
            <li class="right"><a href="../../01/27/re150.html">GreHack 2015 Re150 challenge: as painless as possible</a> &raquo; </li>
        </ul></article><aside class="sidebar"><section><div class="widget">
    <h1>Recent Posts</h1>
    <ul><li>
            <a href="../../../2017/02/03/data_flow_analysis_depgraph.html">Data flow analysis: DepGraph</a>
        </li><li>
            <a href="../../09/03/zeusvm_analysis.html">ZeusVM analysis</a>
        </li><li>
            <a href="../../03/24/re150_rebuild.html">Rebuilding a cleaned & working binary (Re150 part 2)</a>
        </li><li>
            <a href="#">Dynamic shellcode analysis</a>
        </li><li>
            <a href="../../01/27/re150.html">GreHack 2015 Re150 challenge: as painless as possible</a>
        </li><li>
            <a href="../../01/26/welcome.html">Welcome!</a>
        </li></ul>
</div>
</section><section><div class="widget" id="searchbox" role="search">
    <h1><a href="#searchbox">Search</a></h1>
    <form action="../../../search.html" method="get">
        <input type="text" name="q" />
        <button type="submit"><span class="fa fa-search"></span></button>
    </form>
</div></section><section><div class="widget">
    <h1>Contact:</h1>
    <ul>contact at miasm re</ul>
</div></section></aside></div> <!-- #main --></div> <!-- #main-container -->

        <div class="footer-container" role="contentinfo"><footer class="wrapper">&copy; Copyright 2015-2016, Serpilliere. Powered by <a href="http://www.tinkerer.me/">Tinkerer</a> and <a href="http://sphinx.pocoo.org/">Sphinx</a>.</footer></div> <!-- footer-container -->

      </div> <!--! end of #container --><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->
    </body>
</html>